name: Unix tests impl

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      build_type:
        required: true
        type: string

defaults:
  run:
    # micromamba activation
    shell: bash -l -eo pipefail {0}

jobs:
  build_shared_unix:
    name: Build binaries
    runs-on: ${{ inputs.os }}
    steps:
      - name: Checkout mamba repository
        uses: actions/checkout@v4
      - name: Create build environment
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: ./dev/environment-dev.yml
          environment-name: build_env
          cache-environment: true
      - uses: hendrikmuhs/ccache-action@main
        with:
          variant: sccache
          key: ${{ github.job }}-${{ inputs.os }}
          restore-keys: |
            ccache-libmamba-${{ inputs.os }}
      - name: Build mamba
        run: |
          cmake -B build/ -G Ninja \
            --preset mamba-unix-shared-${{ inputs.build_type }}  \
            -D CMAKE_CXX_COMPILER_LAUNCHER=sccache \
            -D CMAKE_C_COMPILER_LAUNCHER=sccache \
            -D BUILD_LIBMAMBAPY=OFF
          cmake --build build/ --parallel
      - name: Show build cache statistics
        run: sccache --show-stats
      - name: Lock environment
        run: micromamba env export --explicit > build/environment.lock
      - name: Remove extra files before saving workspace
        run: find build/ -type f -name '*.o' -exec rm {} +
      - name: Save workspace
        uses: ./.github/actions/workspace
        with:
          action: save
          path: build/
          key_suffix: ${{ inputs.os }}-${{ inputs.build_type }}

  libmamba_tests_unix:
    name: libmamba tests
    needs: ["build_shared_unix"]
    runs-on: ${{ inputs.os }}
    steps:
      - name: Checkout mamba repository
        uses: actions/checkout@v4
      - name: Restore workspace
        uses: ./.github/actions/workspace
        with:
          action: restore
          path: build/
          key_suffix: ${{ inputs.os }}-${{ inputs.build_type }}
      - name: Create build environment
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: ./build/environment.lock
          environment-name: build_env
      - name: Run solv-cpp tests
        run: |
          ./build/libmamba/ext/solv-cpp/tests/test_solv_cpp
      - name: Run libmamba tests
        run: |
          unset CONDARC  # Interferes with tests
          ./build/libmamba/tests/test_libmamba

  libmambapy_tests_unix:
    name: libmambapy tests
    needs: ["build_shared_unix"]
    runs-on: ${{ inputs.os }}
    steps:
      - name: Checkout mamba repository
        uses: actions/checkout@v4
      - name: Restore workspace
        uses: ./.github/actions/workspace
        with:
          action: restore
          path: build/
          key_suffix: ${{ inputs.os }}-${{ inputs.build_type }}
      - name: Create build environment
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: ./build/environment.lock
          environment-name: build_env
      - name: Install libmambapy
        run: |
          cmake --install build/ --prefix "${CONDA_PREFIX}"
          # TODO add some ccache and parallelism to builds
          python -m pip install --no-deps --no-build-isolation ./libmambapy
      - name: Run libmamba Python bindings tests
        run: |
          python -m pytest libmambapy/tests/ ${{ runner.debug == 'true' && '-v' || '--exitfirst' }}

  mamba_integration_tests_unix:
    name: mamba integration tests
    needs: ["build_shared_unix"]
    runs-on: ${{ inputs.os }}
    steps:
      - name: Checkout mamba repository
        uses: actions/checkout@v4
      - name: Restore workspace
        uses: ./.github/actions/workspace
        with:
          action: restore
          path: build/
          key_suffix: ${{ inputs.os }}-${{ inputs.build_type }}
      - name: Create build environment
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: ./build/environment.lock
          environment-name: build_env
      - name: install zsh, xonsh, fish and tcsh in linux
        if: startsWith(inputs.os, 'ubuntu')
        run: |
          sudo apt-get install zsh xonsh fish tcsh -y
      - name: Install xonsh and fish in mac
        if: startsWith(inputs.os, 'macos')
        run: |
          brew install fish xonsh
      - name: Diagnose CURL/DNS issue
        run: |
          echo 'ping -c 3 conda.anaconda.org'
          ping -c 3 conda.anaconda.org || echo 'FAILED'
          echo '--------------------------------------------------'
          echo 'ping -c 3 repo.mamba.pm'
          ping -c 3 repo.mamba.pm || echo 'FAILED'
          echo '--------------------------------------------------'
          echo 'nslookup conda.anaconda.org'
          nslookup conda.anaconda.org || echo 'FAILED'
          echo '--------------------------------------------------'
          echo 'nslookup repo.mamba.pm'
          nslookup repo.mamba.pm || echo 'FAILED'
          echo '--------------------------------------------------'
          echo 'which curl'
          which curl  || echo 'FAILED'
          echo '--------------------------------------------------'
          echo 'curl -I -vvvv https://conda.anaconda.org/conda-forge/noarch/repodata.json'
          curl -I -vvv https://conda.anaconda.org/conda-forge/noarch/repodata.json || echo 'FAILED'
          echo '--------------------------------------------------'
          echo 'curl -I -vvvv https://repo.mamba.pm/conda-forge/noarch/repodata.json'
          curl -I -vvv https://repo.mamba.pm/conda-forge/noarch/repodata.json || echo 'FAILED'

      - name: mamba python based tests
        run: |
          export TEST_MAMBA_EXE=$(pwd)/build/micromamba/mamba
          unset CONDARC  # Interferes with tests
          python -m pytest micromamba/tests/ \
            ${{ runner.debug == 'true' && '-v --capture=tee-sys' || '--exitfirst' }}

  verify_pkg_tests:
    name: mamba-content-trust tests
    needs: ["build_shared_unix"]
    runs-on: ${{ inputs.os }}
    if: startsWith(inputs.os, 'ubuntu')
    steps:
      - name: Checkout mamba repository
        uses: actions/checkout@v4
      - name: Restore workspace
        uses: ./.github/actions/workspace
        with:
          action: restore
          path: build/
          key_suffix: ${{ inputs.os }}-${{ inputs.build_type }}
      - name: Create build environment
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: ./build/environment.lock
          environment-name: build_env
      - name: Run tests using conda-content-trust (server side)
        shell: bash -l {0} -euo pipefail -x
        run: |
          export TEST_MAMBA_EXE=$(pwd)/build/micromamba/mamba
          export MAMBA_ROOT_PREFIX="${HOME}/micromamba"
          unset CONDARC  # Interferes with tests
          cd micromamba/test-server
          ./generate_gpg_keys.sh
          ./testserver_pkg_signing.sh

  mamba_conda_root_prefix_tests:
    name: mamba-conda-root-prefix tests
    runs-on: ${{ inputs.os }}
    if: startsWith(inputs.os, 'ubuntu')
    steps:
      - name: Checkout mamba repository
        uses: actions/checkout@v4
      - name: Create environment with conda
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: conda_env
          create-args: >-
            conda
      - name: Create conda environment containing mamba
        shell: bash -l {0} -euo pipefail -x
        run: |
          # Get a recent version of mamba to have it tested (mamba 2.x)
          conda create -n mamba_in_conda_env mamba=2.0.0rc5 -c conda-forge/label/mamba_dev -y
      - name: Run tests using conda and a nested mamba
        shell: bash -l {0} -euo pipefail -x
        run: |
          conda info
          source "$(conda info --base)/etc/profile.d/conda.sh"  # Initialize Conda
          conda activate mamba_in_conda_env
          # Testing with conda and mamba having the same root prefix
          export MAMBA_ROOT_PREFIX="$(conda info --base)"
          mamba create -n mamba_env_test xtensor -c conda-forge -y
          mamba env list | grep mamba_env_test || { echo "mamba_env_test not found in env list"; exit 1; }
          mamba info | grep "base environment" | grep "$(conda info --base)" || { echo "Expected base environment path not found in mamba info"; exit 1; }
          mamba list -n mamba_env_test | grep xtensor || { echo "xtensor not found in mamba_env_test"; exit 1; }
          eval "$(mamba shell hook --shell bash)"
          mamba activate
          # Since no target prefix has been specified, we should fall back on the root prefix
          mamba info | grep "environment"  | grep "base (active)" || { echo "Expected base environment not active"; exit 1; }
          mamba info | grep "env location" | grep "$(conda info --base)" || { echo "Expected environment not active"; exit 1; }
          # Activate another env - specified
          mamba activate -n mamba_env_test
          mamba info | grep "environment"  | grep "mamba_env_test (active)" || { echo "Expected mamba_env_test environment not active"; exit 1; }
          # Get back to use conda without changing the environment
          conda info | grep "shell level"  | grep "2" || { echo "Expected conda shell level = 2"; exit 1; }
          conda info | grep "active environment"  | grep "mamba_env_test" || { echo "Expected conda environment not active"; exit 1; }
          # Activate another environment using conda
          conda activate mamba_in_conda_env
          conda info | grep "shell level"  | grep "3" || { echo "Expected conda shell level = 3"; exit 1; }
          conda info | grep "active environment"  | grep "mamba_in_conda_env" || { echo "Expected nested conda environment not active"; exit 1; }
